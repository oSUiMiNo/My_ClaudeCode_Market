---
name: codex
argument-hint: "[low|medium|high] <依頼内容>"
allowed-tools: Bash, Write, Edit, Read
# context: fork
description: |
  Codex CLI（OpenAI）を使用してタスク実行・相談・レビューを行う。
  呼び出し元のエージェントの役割は、ユーザーからのプロンプトをこのスキルを遂行するエージェントに横流しすることのみだ。
  諸々の把握や認識はスキル自身がやることなので呼び出し時に、タスクに必要な情報を調査や整理して伝える必要は無い。
  トリガー: "codex", "/codex", "codexと相談", "codexに聞いて", "codexで実行"
---

# ⚠️ 必ず実行： あなたがサブエージェントでない場合は general-purpose を起動しタスクを行わせよ
**1. あなたがサブエージェントあると伝えられている場合は2番以降無視せよ**
**2. あなたがサブエージェントではない場合、下記をあなたがやってはいけない。これ以降のタスクを必ずサブエージェントに任せること。**


# ⚠️ 警告：このスキルはCodex CLIを使う

**あなたが直接回答を生成してはいけない。**
**必ずCodex CLI（OpenAI）を呼び出して回答を得ること。**

---

# 引数のパースと推論強度の決定

## 引数形式

```
[low|medium|high] <依頼内容>
```

## パース手順

1. 引数の最初の単語が`low`/`medium`/`high`のいずれかか確認
2. 該当すればそれを推論強度とし、残りを依頼内容とする
3. 該当しなければ、依頼内容から自動判断

## 自動判断の基準

ユーザーが`--reasoning-effort`を指定しなかった場合、依頼内容から以下の基準で判断：

| 推論強度 | 判断基準 | 例 |
|----------|----------|-----|
| `low` | 単純な事実確認、定義の質問、軽い相談 | 「〇〇とは？」「〇〇の意味を教えて」 |
| `medium` | 一般的な技術相談、比較検討、実装相談 | 「〇〇と△△の違いは？」「〇〇の実装方法」 |
| `high` | 複雑な設計判断、レビュー、深い分析が必要 | 「要件定義書をレビュー」「アーキテクチャ設計」「リスク分析」 |

**デフォルト**: 判断に迷った場合は`medium`を使用。

---

# 最初にやること（例外なし）

**Step -1: 環境チェック（毎回実行・キャッシュで高速）**

```bash
node .claude/skills/codex/scripts/codex-helper.mjs preflight
```

キャッシュ有効（24時間）のため毎回実行しても問題ない。失敗した場合は環境を確認：
- Node.js 22以上が必要
- npx が利用可能であること
- Codex CLI がインストールされていること

**Step 0: 古いログをアーカイブ**

```bash
node .claude/skills/codex/scripts/archive-logs.mjs
```

**Step 1: 既存ログを確認**

```bash
ls .claude/skills/codex/logs/*.md
```

**Step 2: 新規 or 追記を判断**

| 条件 | 判断 |
|------|------|
| 関連トピックのログが存在する | → 追記（`continue`で既存ログに追加） |
| 関連ログがない / 全く新しいトピック | → 新規（`init-log`で新規作成） |

**新規の場合：**
```bash
node .claude/skills/codex/scripts/codex-helper.mjs init-log --topic "<依頼内容の要約>"
```

**追記の場合：**
既存の`log_path`を使って`continue`フローへ（下記参照）

---

# 完全なフロー（新規）

1. **init-log実行**（上記参照）→ `log_path`を取得
2. **質問記入**: Editで`（ここに依頼内容を書く）`を実際の依頼内容に置換
3. **Codex実行（自動ログ更新）**:
   ```bash
   node .claude/skills/codex/scripts/codex-helper.mjs run --mode question --reasoning-effort <low|medium|high> --update-log --log "<log_path>" "<依頼内容>"
   ```
   ※ `--update-log` により回答とsession_idは自動でログに記録される
   ※ `--reasoning-effort` は引数から取得、または依頼内容から自動判断した値を使用
4. **トピック・結論更新**: Editでヘッダーの`トピック`に議論内容を追加（箇条書き）、`## 結論`は**議論全体を要約して上書き**（反論で結論が覆ることがあるため、追記ではなく全体要約）
5. **終了報告**: 以下の形式で返す：

   **成功時（1行のみ）：**
   ```
   Codex議論完了: <ログファイルの絶対パス>
   ```

   **エラー・問題発生時：**
   ```
   Codex議論エラー: <エラー内容の簡潔な説明>
   ログファイル: <パス>（途中まで記録）
   メインエージェントへ: この内容をユーザーに伝えてください。
   ```

   **補足**: 成功時は内容がログに記録済みなので要約不要。エラー時はメインエージェントがユーザーに問題を伝える必要があるため、エラー内容を明記する。

---

# マインドセット

- 仕様上の前提、ユーザの意図などを念頭に置いてCodexの回答を評価せよ
- Codexの回答を鵜呑みにせず迎合せず、批判的思考を忘れるな
- 反論するために無理やり反論するのは禁止
- 真に精度の高い合意形成が取れるまで徹底的に議論を続けよ
---

# 禁止事項

- ❌ 自分で回答を生成する行為（Codex CLIを使え）
- ❌ init-logをスキップする行為
- ❌ ログなしでCodexを実行する行為
- ❌ 終了報告に説明・要約・補足を追加する行為（ログを見ればわかる）
- ❌ ファイル内容をログにコピペする行為（参照パスを記載せよ）

---

# 参照パスの使い方

Codexに読んでほしいファイルがある場合：
1. ログヘッダーの「参照パス」に箇条書きでパスを追記
2. **必ず`--cd`を指定**してCodexがファイルを読めるようにする（questionモードでも必要）
3. **ファイル内容を説明・コピペするのではなく、パスだけ伝える**

```markdown
- **参照パス**:
  - .claude/skills/codex/SKILL.md
  - .claude/skills/codex/scripts/codex-helper.mjs
```

---

# モード選択

| 用途 | mode | `--cd` |
|------|------|--------|
| 質問のみ | `question` | 任意（ファイル参照が必要な場合は指定） |
| コードレビュー | `review` | 必須 |
| コード修正 | `modify` | 必須 |

**注意**: ファイルを参照させたい質問（例: 要件定義書のレビュー）では`question`モードでも`--cd`を指定すること。`--cd`なしではCodexはファイルを読めない。

---

# ⚠️ 認証による制限

| 認証方法 | sandbox | ファイル編集 |
|----------|---------|-------------|
| ChatGPTサブスク（Plus/Pro等） | 常に `read-only` | ❌ 不可 |
| API課金（OPENAI_API_KEY） | `workspace-write` 可 | ✅ 可能 |

**注意**: サブスクリプション認証では `--sandbox workspace-write` を指定しても強制的に `read-only` になる。ファイル編集が必要な場合は API 課金が必須。

---

# 継続/終了の判断

| 状態 | 判断 |
|------|------|
| 明確な回答が得られた | 終了（単発でOK） |
| 曖昧/不完全/懸念あり | ラリー継続（セクション番号をインクリメント） |

ラリー継続時は`continue`コマンドを使用：
```bash
node .claude/skills/codex/scripts/codex-helper.mjs continue --reasoning-effort <low|medium|high> --update-log --log "<log_path>" "<追加の質問>"
```
※ `--update-log` により質問・回答・session_idが自動でログに追記される
※ `--reasoning-effort` は継続する議論の複雑さに応じて判断
※ログファイルをCodexに読ませて議論を再開する（セッションIDに依存しない）

**注意**: `continue`コマンドはWeb検索に対応していない（`codex exec`を使用）。Web検索が必要な継続議論は、`run --search`で新しい質問を投げ、プロンプト内で「前回のログ（パス）を参照して」と指示する。

---

# 後日の議論再開

完了した議論を後から深掘りする場合：
1. 既存のログを指定して`continue`実行
2. 同じログファイルにラリーを追記（(2), (3)...）
3. トピック（箇条書き）と結論を更新して終了

---

# Web検索対応モード（`--search`オプション）

## 概要

`--search`オプションを使用すると、Codex CLIがWeb検索機能を有効にした状態で実行される。
最新情報やリアルタイムデータが必要な場合に使用する。

## Web検索の積極的活用

**原則**: 最新情報が関係する可能性がある場合は、迷わず`--search`を使用せよ。

以下の場合は`--search`オプションを使用：
- 最新情報が必要なとき（ニュース、最新ドキュメント等）
- リアルタイムデータが必要なとき（天気、株価等）
- 最新のライブラリバージョンやAPI仕様を確認するとき
- **ベストプラクティスや推奨手法を確認するとき**（技術は常に進化する）
- **不確実性がある場合**（古い情報かもしれないと感じたら検索）

## 使用例

```bash
# Step 1: ログを初期化（従来通り）
node .claude/skills/codex/scripts/codex-helper.mjs init-log --topic "web-search-test"

# Step 2: --search オプション付きで実行（Web検索有効 + 自動ログ更新）
node .claude/skills/codex/scripts/codex-helper.mjs run --mode question --search --update-log --log <log_path> "2026年の東京の天気を教えて"
# → Web検索結果を含む応答、ログに自動記録
```

## 従来モード vs Web検索モード

| 観点 | 従来モード（run） | Web検索モード（run --search） |
|------|-------------------|------------------------------|
| コマンド | `codex exec` | PTY + `codex --search` |
| Web検索 | ❌ 不可 | ✅ 可能 |
| 実行方式 | 非インタラクティブ | PTYセッション（単発） |
| 適用場面 | 静的な質問、コードレビュー | 最新情報が必要な質問 |

## 注意事項

- PTYセッションはWindows 10 build 18309以上が必要（ConPTYサポート）
- 各実行は独立したセッション（複数ラリーは`continue`コマンドを使用）
- タイムアウト（デフォルト10分）は`--timeout`で調整可能

---

# 初回セットアップ

このスキルを初めて使用する前に、依存関係をインストール：

```bash
cd .claude/skills/codex/scripts && npm ci
```

これにより node-pty 等の必要なパッケージがインストールされる。
